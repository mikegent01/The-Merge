<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>185th NM Breaking News - Live Election Results</title>

    <!-- --- CSS --- -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f0f0f0;
        }

        header {
            background-color: #003366;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .live-badge {
            background-color: #cc0000;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            animation: pulsate 2s infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes pulsate {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .viewer-counter {
            margin-top: 10px;
            font-size: 0.9em;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .election-info {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .election-metadata {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
         .election-metadata > div {
             text-align: center;
             flex: 1;
             min-width: 150px;
             margin: 5px;
         }
         .election-metadata .label {
             font-size: 0.9em;
             color: #666;
         }
         .election-metadata .value {
             font-size: 1.3em;
             font-weight: bold;
         }


        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #eee;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            text-align: center; /* Center tab text */
            flex-grow: 1; /* Make tabs grow to fill space */
        }

        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .arch-parliament {
            position: relative;
            width: 100%;
            height: 200px; /* Reduced height further for smaller arc */
            margin: 20px 0;
            overflow: hidden; /* Hide seats outside the bounds */
        }


        .seat {
            position: absolute;
            width: 8px; /* Reduced size */
            height: 8px; /* Reduced size */
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s ease; /* Faster transition */
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .seat:hover {
            transform: scale(2); /* Increased scale on hover */
            z-index: 10;
             border-color: rgba(255,255,255,0.8);
        }

        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px 10px 0;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
            border: 1px solid rgba(0,0,0,0.2);
        }

        .presidential-race {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .candidate {
            flex: 1;
            text-align: center;
            padding: 20px;
            border-radius: 5px;
            margin: 0 10px;
            color: white;
            min-width: 250px;
        }

        .candidate h3 {
            margin-top: 0;
        }

        .votes-counter {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .electoral-votes {
            font-weight: bold;
        }

         .seat-counts { /* Style for House/Senate seat counts */
             display: flex;
             justify-content: space-around;
             flex-wrap: wrap;
             margin-top: 15px;
             font-size: 0.95em;
         }
          .seat-count-item {
             text-align: center;
             margin: 5px 10px;
          }
          .seat-count-item strong {
             font-size: 1.2em;
          }
          .party-lead {
             text-align: center;
             margin-top: 15px;
             font-size: 1.1em;
             font-weight: bold;
          }
           .party-lead.ua { color: #D22B2B; }
           .party-lead.mfa { color: #9370DB; }


        .results-bar {
            height: 30px;
            background-color: #ddd;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: flex;
            position: relative;
        }

         .results-bar span {
             position: absolute;
             left: 50%;
             top: 50%;
             transform: translate(-50%, -50%);
             color: #333;
             font-weight: bold;
             z-index: 1;
             font-size: 1.1em;
             text-shadow: 0 0 3px rgba(255,255,255,0.5);
         }


        .results-progress {
            height: 100%;
            transition: width 0.3s ease-out;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            box-sizing: border-box;
            overflow: hidden;
            justify-content: flex-start;
        }

         .results-progress-meowbah {
             height: 100%;
             transition: width 0.3s ease-out;
             display: flex;
             align-items: center;
             justify-content: flex-end;
             padding-right: 10px;
             color: white;
             font-weight: bold;
             background-color: #9370DB;
             box-sizing: border-box;
             overflow: hidden;
         }


        .controls {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center; /* Align toggle */
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #003366;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #004c99;
        }

         .mode-toggle { /* Style for mode toggle */
             margin-left: 20px;
             display: flex;
             align-items: center;
             font-size: 0.9em;
         }
          .mode-toggle input[type="checkbox"] {
             margin-right: 5px;
             cursor: pointer;
          }


        .map-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .map {
            width: 48%;
            margin-bottom: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        .map svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .map svg rect {
            stroke: #fff;
            stroke-width: 1;
            transition: stroke-width 0.2s ease, stroke 0.2s ease;
        }

        .map svg rect:hover {
            stroke: #333;
            stroke-width: 3;
        }

         .map svg text {
             fill: #fff;
             font-size: 8px;
             font-weight: bold;
             pointer-events: none;
             text-shadow: 0 0 2px rgba(0,0,0,0.5);
         }


        .info-box { /* Unified style for seat and map info boxes */
            position: fixed;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 5px;
            pointer-events: none;
            display: none;
            font-size: 0.9em;
        }

        .polling-data {
            background-color: #f9f9f9;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .polling-data table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .polling-data th, .polling-data td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
         .polling-data th {
             border-bottom: 2px solid #ddd;
         }


        .news-ticker {
            background-color: #003366;
            color: white;
            padding: 10px;
            overflow: hidden;
            white-space: nowrap;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 60s linear infinite;
        }

        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .winner-content {
            background-color: #003366;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
             box-shadow: 0 5px 15px rgba(0,0,0,0.5);
             animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        .winner-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .exit-code {
            font-family: monospace;
            background-color: #001a33;
            padding: 10px;
            border-radius: 5px;
            margin: 20px 0;
             word-break: break-all;
        }

        #close-modal {
            margin-top: 20px;
            background-color: #cc0000;
        }
         #close-modal:hover {
            background-color: #ff3333;
         }


        @media (max-width: 768px) {
            .map {
                width: 100%;
            }

            .presidential-race {
                flex-direction: column;
            }

            .candidate {
                margin: 10px 0;
            }
             .tabs {
                 flex-wrap: wrap;
             }
             .tab {
                 flex: 1;
                 text-align: center;
                 margin-right: 0;
                 margin-bottom: 5px;
             }
             .tab.active {
                 margin-bottom: -1px;
             }
             .election-metadata > div {
                  min-width: 100px;
             }
        }
    </style>
</head>
<body>
    <!-- --- HTML Structure --- -->
    <header>
        <h1>NM Breaking News <span class="live-badge">LIVE</span></h1>
        <p>185th Issue - Live Election Results</p>
        <!-- Viewer counter will be added here by JS -->
    </header>

    <div class="container">
        <div class="election-info">
            <h2>2025 United States Elections</h2>
            <p>As tensions rise with Serbia and the "neo continental system," Americans head to the polls to decide the future of the nation. Incumbent President John Davis faces challenger Meowbah of the 'Meow For All' party in a historic election amidst economic uncertainty and international diplomacy concerns.</p>
            <!-- Metadata will be added here by JS -->
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="presidential">Presidential Race</div>
            <div class="tab" data-tab="house">House</div>
            <div class="tab" data-tab="senate">Senate</div>
        </div>

        <div id="presidential" class="tab-content active">
            <h2>Presidential Election Results</h2>
            <div class="presidential-race">
                <div class="candidate" id="candidate1" style="background-color: #D22B2B;">
                    <h3>John Davis</h3>
                    <p>United America Party</p>
                    <div class="votes-counter" id="davis-votes">0</div>
                    <div class="electoral-votes" id="davis-electoral">0 electoral votes</div>
                </div>
                <div class="candidate" id="candidate2" style="background-color: #9370DB;">
                    <h3>Meowbah</h3>
                    <p>Meow For All Party</p>
                    <div class="votes-counter" id="meowbah-votes">0</div>
                    <div class="electoral-votes" id="meowbah-electoral">0 electoral votes</div>
                </div>
            </div>

            <div class="results-bar">
                 <span>0% Reported</span>
                <div class="results-progress" id="davis-progress" style="width: 0%; background-color: #D22B2B;"></div>
                 <div class="results-progress-meowbah" id="meowbah-progress" style="width: 0%;"></div>
            </div>

            <div class="arch-parliament" id="presidential-parliament">
                <!-- Seats will be generated by JavaScript -->
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #D22B2B;"></div>
                    <span>United America Party</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9370DB;"></div>
                    <span>Meow For All Party</span>
                </div>
                 <div class="legend-item">
                     <div class="legend-color" style="background-color: #ccc;"></div>
                     <span>Undecided/Remaining</span>
                 </div>
            </div>
             <!-- Polling data will be added here by JS -->
        </div>

        <div id="house" class="tab-content">
            <h2>House of Representatives Results</h2>

             <div class="party-lead" id="house-lead"></div>
             <div class="seat-counts" id="house-seat-counts">
                <!-- Seat counts will be added here by JS -->
             </div>

            <div class="arch-parliament" id="house-parliament">
                <!-- Seats will be generated by JavaScript -->
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #D22B2B;"></div>
                    <span>United America</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9370DB;"></div>
                    <span>Meow For All</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3CB371;"></div>
                    <span>Green Future</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFD700;"></div>
                    <span>Prosperity Alliance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4169E1;"></div>
                    <span>Liberty Coalition</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF8C00;"></div>
                    <span>Patriot Union</span>
                </div>
                 <div class="legend-item">
                     <div class="legend-color" style="background-color: #ccc;"></div>
                     <span>Undecided/Remaining</span>
                 </div>
            </div>

            <div class="map-container">
                <div class="map">
                    <h3>House Map by District</h3>
                    <svg id="house-map" viewBox="0 0 800 500">
                        <!-- USA map with simplified districts will be generated by JavaScript -->
                    </svg>
                </div>
            </div>
             <!-- Placeholder for Speaker Name -->
             <p style="text-align: center; margin-top: 20px; font-weight: bold;">House Speaker: <span id="house-speaker"></span></p>

             <!-- Polling data will be added here by JS -->
        </div>

        <div id="senate" class="tab-content">
            <h2>Senate Election Results</h2>

             <div class="party-lead" id="senate-lead"></div>
             <div class="seat-counts" id="senate-seat-counts">
                 <!-- Seat counts will be added here by JS -->
             </div>

            <div class="arch-parliament" id="senate-parliament">
                <!-- Seats will be generated by JavaScript -->
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #D22B2B;"></div>
                    <span>United America</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9370DB;"></div>
                    <span>Meow For All</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3CB371;"></div>
                    <span>Green Future</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFD700;"></div>
                    <span>Prosperity Alliance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4169E1;"></div>
                    <span>Liberty Coalition</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF8C00;"></div>
                    <span>Patriot Union</span>
                </div>
                 <div class="legend-item">
                     <div class="legend-color" style="background-color: #ccc;"></div>
                     <span>Undecided/Remaining</span>
                 </div>
            </div>

            <div class="map-container">
                <div class="map">
                    <h3>Senate Map by State</h3>
                    <svg id="senate-map" viewBox="0 0 800 500">
                        <!-- USA map with states will be generated by JavaScript -->
                    </svg>
                </div>
            </div>
             <!-- Placeholder for Majority Leader Name -->
            <p style="text-align: center; margin-top: 20px; font-weight: bold;">Senate Majority Leader: <span id="senate-leader"></span></p>

             <!-- Polling data will be added here by JS -->
        </div>

        <div class="controls">
            <button id="reset-btn">Reset & Start Election</button>
             <div class="mode-toggle">
                 <input type="checkbox" id="live-mode-toggle">
                 <label for="live-mode-toggle"><span id="mode-label">Live Mode</span></label>
             </div>
        </div>
    </div>

    <div class="news-ticker">
        <div class="ticker-content">
            BREAKING NEWS: Polls closing across the Eastern timezone | President John Davis visits evacuation centers in North Dakota | Vice President Jill Soulstien released from hospital after health scare | Serbia alliance with Russia raises international concerns | China deal negotiations near completion | Dow Jones drops 2 points as inflation stabilizes | Second presidential debate scheduled for Monday | Stay tuned for live election results on NM Breaking News with Joe Curtus
        </div>
    </div>

    <div class="winner-modal" id="winner-modal">
        <div class="winner-content">
            <h2 id="winner-name">Winner Announced!</h2>
            <p id="winner-message">Has won the presidential election!</p>
            <div class="exit-code" id="exit-code">EXIT CODE: XXXXXXXX</div>
            <button id="close-modal">Continue Watching Results</button>
        </div>
    </div>

    <!-- Info box element for seat and map hover -->
    <div class="info-box" id="info-box"></div>


    <!-- --- JavaScript --- -->
    <script>
        // Party colors
        const partyColors = {
            unitedAmerica: '#D22B2B',    // Red
            meowForAll: '#9370DB',       // Purple
            greenFuture: '#3CB371',      // Green
            prosperityAlliance: '#FFD700', // Gold
            libertyCoalition: '#4169E1', // Royal Blue
            patriotUnion: '#FF8C00'      // Dark Orange
        };

        // Total seats/electoral votes
        const totalEVs = 538;
        const totalHouseSeats = 435;
        const totalSenateSeats = 100; // 2 senators * 50 states
        const presidentialThreshold = 270; // Electoral votes needed to win

        // State variables for *displayed* results
        let displayedPresidentialEVs = { unitedAmerica: 0, meowForAll: 0 };
        let displayedHouseSeats = { unitedAmerica: 0, meowForAll: 0, greenFuture: 0, prosperityAlliance: 0, libertyCoalition: 0, patriotUnion: 0 };
        let displayedSenateSeats = { unitedAmerica: 0, meowForAll: 0, greenFuture: 0, prosperityAlliance: 0, libertyCoalition: 0, patriotUnion: 0 };

        // State variables for *target* final results (set on reset/load)
        let targetPresidentialEVs = { unitedAmerica: 0, meowForAll: 0 };
        let targetHouseSeats = { unitedAmerica: 0, meowForAll: 0, greenFuture: 0, prosperityAlliance: 0, libertyCoalition: 0, patriotUnion: 0 };
        let targetSenateSeats = { unitedAmerica: 0, meowForAll: 0, greenFuture: 0, prosperityAlliance: 0, libertyCoalition: 0, patriotUnion: 0 };

        // Progress percentage for each body (0-100) - Represents percentage of votes/districts/states reported
        let presidentialProgress = 0;
        let houseProgress = 0;
        let senateProgress = 0;
        let totalProgressAverage = 0; // Will store the average progress for metadata

        let updateInterval = null; // Stores the interval ID
        const updateIntervalTime = 300; // Time between steps in milliseconds (300ms = 0.3s)
        const progressIncrementPerStep = 1; // Percentage points to increment per step (1% per step = 100 steps total)

        let winnerDeclared = false; // Flag to prevent multiple winner popups
        let isLiveMode = true; // State for the mode toggle

        // Names for random generation
         const firstNames = ["John", "Mary", "David", "Sarah", "Michael", "Emily", "Chris", "Jessica", "James", "Ashley", "Robert", "Amanda", "William", "Elizabeth", "Richard", "Stephanie", "Joseph", "Nicole", "Thomas", "Megan", "Charles", "Lauren", "Matthew", "Kimberly", "Daniel", "Christina", "Anthony", "Rachel", "Kevin", "Heather"];
         const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Miller", "Davis", "Garcia", "Rodriguez", "Wilson", "Martinez", "Anderson", "Taylor", "Thomas", "Hernandez", "Moore", "Martin", "Jackson", "Thompson", "White", "Lopez", "Lee", "Gonzalez", "Harris", "Clark", "Lewis", "Robinson", "Walker", "Perez", "Hall"];

         function generateRandomName() {
             const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
             const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
             return `${firstName} ${lastName}`;
         }

        let houseSpeakerName = "";
        let senateLeaderName = "";


        // Helper to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        // Function to generate random target results
        function generateTargetResults() {
             // Presidential
            targetPresidentialEVs.unitedAmerica = Math.floor(Math.random() * (totalEVs + 1));
            targetPresidentialEVs.meowForAll = totalEVs - targetPresidentialEVs.unitedAmerica;

             // House (Distribute 435 seats randomly among parties)
             const partiesHouse = Object.keys(targetHouseSeats);
             partiesHouse.forEach(party => targetHouseSeats[party] = 0);
             for(let i = 0; i < totalHouseSeats; i++) {
                 const randomParty = partiesHouse[Math.floor(Math.random() * partiesHouse.length)];
                 targetHouseSeats[randomParty]++;
             }

             // Senate (Distribute 100 seats randomly among parties)
             const partiesSenate = Object.keys(targetSenateSeats);
             partiesSenate.forEach(party => targetSenateSeats[party] = 0);
             for(let i = 0; i < totalSenateSeats; i++) {
                 const randomParty = partiesSenate[Math.floor(Math.random() * partiesSenate.length)];
                 targetSenateSeats[randomParty]++;
             }
             console.log("Target Results Generated:", {targetPresidentialEVs, targetHouseSeats, targetSenateSeats});

             // Generate Speaker/Leader names for the end state
             houseSpeakerName = generateRandomName();
             senateLeaderName = generateRandomName();
        }


        // Function to generate arch parliament visualization (Grouped by party)
        function generateArchParliament(containerId, seats, totalSeats) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; // Clear previous seats

            const width = container.offsetWidth;
            const height = container.offsetHeight;

            // Adjustments for positioning the arc within the container height
            // Center the arc below the container's top edge to fit within the height
            const arcCenterY = height + height * 0.5; // Center point relative to container top, below bottom edge
            const arcRadius = height * 1.2; // Radius of the arc

            // Angles for a wide arc covering most of the semicircle bottom
            const startAngle = Math.PI * 0.85; // e.g., 153 degrees
            const endAngle = Math.PI * 0.15;  // e.g., 27 degrees


            // Create an array of party names based on displayed seat counts, grouped
            const partyListGrouped = [];
            const parties = Object.keys(seats); // Get party names

            // Add seats for each party sequentially
            parties.forEach(partyName => {
                for (let i = 0; i < seats[partyName]; i++) {
                    partyListGrouped.push(partyName);
                }
            });

            // Add placeholder seats for the remaining ones
            const displayedTotal = Object.values(seats).reduce((sum, count) => sum + count, 0);
            const remainingSeats = totalSeats - displayedTotal;
             for (let i = 0; i < remainingSeats; i++) {
                partyListGrouped.push('empty'); // Use 'empty' for unassigned seats
            }


            // Calculate seat positions on the arc
            let seatIndex = 0;
            const rowHeight = 16; // Vertical spacing between rows
            let currentRow = 0;
            const angleRange = startAngle - endAngle;

             // Calculate max seats per row based on the largest circle (outermost)
            const maxSeatsOuterRow = Math.floor((arcRadius * angleRange) / 13); // 13 is approx seat spacing along arc

             // Number of rows is roughly total seats / max seats per row, but adjust for arc shape
             // A simpler approach is to define a fixed number of rows and distribute seats.
             const totalRows = 8; // Fixed number of rows
             const radiusStep = arcRadius / totalRows;


            while (seatIndex < totalSeats) {
                 currentRow++;
                 if (currentRow > totalRows) break; // Prevent infinite loop if calculation is off

                 const currentRadius = arcRadius - (currentRow * radiusStep); // Decrease radius linearly

                 if (currentRadius <= 0) break;

                 // Calculate number of seats for *this specific* row based on its radius
                 const seatsInThisRow = Math.floor((currentRadius * angleRange) / 13);

                 // Distribute the *next* N seats onto this row's calculated positions
                 const numSeatsToPlaceInRow = Math.min(seatsInThisRow, totalSeats - seatIndex);

                 if (numSeatsToPlaceInRow <= 0) break;

                 const angleStep = numSeatsToPlaceInRow > 1 ? angleRange / (numSeatsToPlaceInRow - 1) : 0;


                 for (let i = 0; i < numSeatsToPlaceInRow && seatIndex < totalSeats; i++) {
                     const angle = startAngle - (angleStep * i);
                     const x = centerX + currentRadius * Math.cos(angle);
                     const y = arcCenterY - currentRadius * Math.sin(angle);

                     const seat = document.createElement('div');
                     seat.className = 'seat';
                     // Position relative to the container's top-left
                     seat.style.left = `${x - 4}px`; // Adjust for seat size
                     seat.style.top = `${y - 4}px`; // Adjust for seat size

                     const party = partyListGrouped[seatIndex]; // Get party from the grouped list
                     if (party !== 'empty' && partyColors[party]) {
                         seat.style.backgroundColor = partyColors[party];
                         seat.setAttribute('data-party', party);
                         seat.setAttribute('data-seat-index', seatIndex + 1); // Add index for hover
                     } else {
                         seat.style.backgroundColor = '#ccc';
                         seat.setAttribute('data-party', 'empty');
                         seat.setAttribute('data-seat-index', seatIndex + 1); // Add index for hover
                     }

                      // Add hover interactivity directly here
                     addSeatInteractivity(seat);

                     container.appendChild(seat);
                     seatIndex++;
                 }
            }
             // console.log(`Generated ${seatIndex} seats for ${containerId}`);
        }


        // Function to generate USA map (simplified grid)
        function generateMap(svgId, totalItems, displayedSeats, parties, type) { // type: 'district' or 'state'
            const svg = document.getElementById(svgId);
            if (!svg) return;
            const width = 800;
            const height = 500;

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.innerHTML = ''; // Clear previous map

            let items = totalItems;
            let cols, rows, abbreviationList = [];

            if (type === 'district') {
                cols = 10; rows = 10;
            } else if (type === 'state') {
                cols = 10; rows = 5; // 50 states
                abbreviationList = [
                    'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
                    'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
                    'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
                    'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
                    'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
                ];
            } else {
                return; // Unknown map type
            }

            const rectWidth = width / cols;
            const rectHeight = height / rows;

            // Create a list of parties based on *displayed* counts, then shuffle for random placement on the grid
            const displayedPartyListShuffled = [];
            for(const party in displayedSeats) {
                for(let i = 0; i < displayedSeats[party]; i++) {
                    displayedPartyListShuffled.push(party);
                }
            }
            // Add placeholders for remaining items
            const displayedTotal = Object.values(displayedSeats).reduce((sum, count) => sum + count, 0);
            const remainingItems = items - displayedTotal; // Note: items is 100 or 50
             for(let i = 0; i < remainingItems; i++) {
                 displayedPartyListShuffled.push('empty');
             }
             shuffleArray(displayedPartyListShuffled); // Shuffle the list


            for (let i = 0; i < items; i++) {
                const row = Math.floor(i / cols);
                const col = i % cols;

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', col * rectWidth);
                rect.setAttribute('y', row * rectHeight);
                rect.setAttribute('width', rectWidth);
                rect.setAttribute('height', rectHeight);

                // Assign color based on the shuffled displayed list
                const party = displayedPartyListShuffled[i] || 'empty'; // Fallback
                const color = partyColors[party] || '#ccc'; // Grey for undecided
                rect.setAttribute('fill', color);
                rect.setAttribute('data-party', party);

                // Add relevant data attribute for interactivity
                 if (type === 'district') {
                     rect.setAttribute('data-district-id', i + 1);
                 } else if (type === 'state') {
                     rect.setAttribute('data-state-abbr', abbreviationList[i] || `S${i+1}`);
                 }


                // Add label (District ID or State Abbreviation)
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', col * rectWidth + rectWidth / 2);
                text.setAttribute('y', row * rectHeight + rectHeight / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.textContent = type === 'district' ? `D${i + 1}` : (abbreviationList[i] || `S${i+1}`);

                svg.appendChild(rect);
                svg.appendChild(text);
            }
             // Add interactivity after elements are created
            addMapInteractivity(svg, type);
             // console.log(`Generated ${type} map with ${displayedTotal} items assigned`);
        }


        // Function to perform one step of results update
        function stepUpdateResults() {
             // Stop if all results are reported
             if (presidentialProgress >= 100 && houseProgress >= 100 && senateProgress >= 100) {
                 clearInterval(updateInterval);
                 updateInterval = null; // Clear the variable
                 console.log("Election results fully reported.");
                 checkWinner(); // Final winner check
                 return; // Stop the function
             }

             // 1. Increment progress percentages (don't exceed 100)
             // Check if we are already at the target progress from URL
             const urlDay = getDayFromUrl();
             if (!isLiveMode && urlDay !== null && presidentialProgress >= urlDay && houseProgress >= urlDay && senateProgress >= urlDay) {
                  // If in Day mode and already reached the day from URL, stop interval (if it somehow got started)
                  clearInterval(updateInterval);
                  updateInterval = null;
                  return;
             }

            presidentialProgress = Math.min(100, presidentialProgress + progressIncrementPerStep);
            houseProgress = Math.min(100, houseProgress + progressIncrementPerStep);
            senateProgress = Math.min(100, senateProgress + progressIncrementPerStep);

            // In Advance by Day mode, only update up to the requested day
             if (!isLiveMode && urlDay !== null) {
                 presidentialProgress = Math.min(presidentialProgress, urlDay);
                 houseProgress = Math.min(houseProgress, urlDay);
                 senateProgress = Math.min(senateProgress, urlDay);
             }


            // 2. Calculate total items to display based on current progress
            const currentTotalDisplayedEVs = Math.floor(totalEVs * (presidentialProgress / 100));
            const currentTotalDisplayedHouse = Math.floor(totalHouseSeats * (houseProgress / 100));
            const currentTotalDisplayedSenate = Math.floor(totalSenateSeats * (senateProgress / 100));

             // 3. Distribute the current total items among parties based on target proportions
             // Presidential
            displayedPresidentialEVs = { unitedAmerica: 0, meowForAll: 0 };
             if (currentTotalDisplayedEVs > 0) {
                 // Calculate proportions based on target EVs
                 const uaProp = targetPresidentialEVs.unitedAmerica / totalEVs;
                 const mfaProp = targetPresidentialEVs.meowForAll / totalEVs;

                 // Distribute current EVs based on proportions
                 displayedPresidentialEVs.unitedAmerica = Math.round(uaProp * currentTotalDisplayedEVs);
                 displayedPresidentialEVs.meowForAll = currentTotalDisplayedEVs - displayedPresidentialEVs.unitedAmerica; // Ensure total adds up
             }


             // House
             const partiesHouse = Object.keys(targetHouseSeats);
            displayedHouseSeats = {};
            let sumRoundedHouse = 0;
            if (currentTotalDisplayedHouse > 0) {
                 const totalTargetHouse = Object.values(targetHouseSeats).reduce((sum, count) => sum + count, 0);
                 partiesHouse.forEach(party => {
                     const targetProportion = (targetHouseSeats[party] / totalTargetHouse) || 0;
                     displayedHouseSeats[party] = Math.round(targetProportion * currentTotalDisplayedHouse);
                     sumRoundedHouse += displayedHouseSeats[party];
                 });
                let houseDiff = currentTotalDisplayedHouse - sumRoundedHouse;
                 const allParties = Object.keys(targetHouseSeats);
                 while (houseDiff !== 0) {
                     const partyToAdjust = allParties[Math.floor(Math.random() * allParties.length)];
                      if (houseDiff > 0) { displayedHouseSeats[partyToAdjust] = (displayedHouseSeats[partyToAdjust] || 0) + 1; houseDiff--; }
                      else { if((displayedHouseSeats[partyToAdjust] || 0) > 0) { displayedHouseSeats[partyToAdjust]--; houseDiff++; } else { break; } }
                 }
            } else {
                 partiesHouse.forEach(party => displayedHouseSeats[party] = 0);
            }


             // Senate
             const partiesSenate = Object.keys(targetSenateSeats);
             displayedSenateSeats = {};
             let sumRoundedSenate = 0;
            if (currentTotalDisplayedSenate > 0) {
                 const totalTargetSenate = Object.values(targetSenateSeats).reduce((sum, count) => sum + count, 0);
                 partiesSenate.forEach(party => {
                     const targetProportion = (targetSenateSeats[party] / totalTargetSenate) || 0;
                     displayedSenateSeats[party] = Math.round(targetProportion * currentTotalDisplayedSenate);
                     sumRoundedSenate += displayedSenateSeats[party];
                 });
                let senateDiff = currentTotalDisplayedSenate - sumRoundedSenate;
                 const allParties = Object.keys(targetSenateSeats);
                 while (senateDiff !== 0) {
                      const partyToAdjust = allParties[Math.floor(Math.random() * allParties.length)];
                       if (senateDiff > 0) { displayedSenateSeats[partyToAdjust] = (displayedSenateSeats[partyToAdjust] || 0) + 1; senateDiff--; }
                       else { if((displayedSenateSeats[partyToAdjust] || 0) > 0) { displayedSenateSeats[partyToAdjust]--; senateDiff++; } else { break; } }
                 }
            } else {
                 partiesSenate.forEach(party => displayedSenateSeats[party] = 0);
            }


            // 4. Update the display elements
            // Presidential Counts & Bar
            document.getElementById('davis-votes').textContent = (displayedPresidentialEVs.unitedAmerica * 1000000).toLocaleString(); // Scale EVs up for popular votes
            document.getElementById('meowbah-votes').textContent = (displayedPresidentialEVs.meowForAll * 1000000).toLocaleString();
            document.getElementById('davis-electoral').textContent = `${displayedPresidentialEVs.unitedAmerica} electoral votes`;
            document.getElementById('meowbah-electoral').textContent = `${displayedPresidentialEVs.meowForAll} electoral votes`;

            const davisPercentage = (displayedPresidentialEVs.unitedAmerica / totalEVs * 100); // Don't fix to 1 decimal until display
            const meowbahPercentage = (displayedPresidentialEVs.meowForAll / totalEVs * 100);
            totalProgressAverage = (presidentialProgress + houseProgress + senateProgress) / 3; // Update average progress
            const reportedPercentage = Math.floor(totalProgressAverage);


            document.getElementById('davis-progress').style.width = `${davisPercentage}%`;
            document.getElementById('meowbah-progress').style.width = `${meowbahPercentage}%`;

            const davisProgressBar = document.getElementById('davis-progress');
            const meowbahProgressBar = document.getElementById('meowbah-progress');

            davisProgressBar.textContent = davisPercentage > 5 ? `${davisPercentage.toFixed(1)}%` : '';
            meowbahProgressBar.textContent = meowbahPercentage > 5 ? `${meowbahPercentage.toFixed(1)}%` : '';

            const reportedSpan = document.querySelector('.results-bar span');
            if(reportedSpan) {
                 reportedSpan.textContent = `${reportedPercentage}% Reported`;
            }

             // Update House and Senate counts and leads
             updateHouseSenateCountsAndLead();

             // Update Speaker/Leader names if results are fully reported
             if (houseProgress === 100) {
                  document.getElementById('house-speaker').textContent = houseSpeakerName;
             } else {
                   document.getElementById('house-speaker').textContent = 'Undetermined';
             }
              if (senateProgress === 100) {
                   document.getElementById('senate-leader').textContent = senateLeaderName;
              } else {
                  document.getElementById('senate-leader').textContent = 'Undetermined';
              }


            // Update visualizations only for the currently active tab
            const activeTabId = document.querySelector('.tab.active').dataset.tab;

            if (activeTabId === 'presidential') {
                generateArchParliament('presidential-parliament', displayedPresidentialEVs, totalEVs);
            } else if (activeTabId === 'house') {
                generateArchParliament('house-parliament', displayedHouseSeats, totalHouseSeats);
                generateMap('house-map', 100, displayedHouseSeats, partiesHouse, 'district'); // Pass item count (100 districts)
            } else if (activeTabId === 'senate') {
                generateArchParliament('senate-parliament', displayedSenateSeats, totalSenateSeats);
                 generateMap('senate-map', 50, displayedSenateSeats, partiesSenate, 'state'); // Pass item count (50 states)
            }

            // 5. Update metadata values
             initializeAdditionalFeatures();

            // 6. Check for winner (only when presidential results are fully reported)
            if (presidentialProgress === 100) {
                checkWinner();
            }

             // 7. Update Polling Data (update less frequently, e.g., every 10 steps)
             if (presidentialProgress % (progressIncrementPerStep * 10) === 0 || presidentialProgress === 100) { // Update every ~10% progress or at 100%
                  addPollingData();
             }

             // 8. Update URL if in Live Mode
             if (isLiveMode) {
                 const currentDay = Math.floor(totalProgressAverage); // Use average progress for the 'day'
                 // Avoid updating history too rapidly or unnecessarily
                 const currentUrlDay = getDayFromUrl();
                 if (currentUrlDay === null || Math.abs(currentDay - currentUrlDay) >= 1) { // Update if no day or changed by >= 1
                     const newUrl = `${window.location.origin}${window.location.pathname}?day=${currentDay}`;
                     history.replaceState({ day: currentDay }, '', newUrl); // Use replaceState to avoid cluttering history
                 }
             } else {
                  // In Day mode, the URL is set by the toggle or manual edit
                  // Ensure the display matches the URL's day value if it was manually changed
                   if (urlDay !== null && (presidentialProgress !== urlDay || houseProgress !== urlDay || senateProgress !== urlDay)) {
                       // This case shouldn't happen if stepUpdateResults correctly caps progress in day mode,
                       // but as a safeguard: if URL day is different, recalculate and redraw.
                       console.warn("Progress out of sync with URL day, resetting display.");
                       setElectionStateFromDay(urlDay);
                   }
             }

        }

        // Update House and Senate displayed counts and lead
        function updateHouseSenateCountsAndLead() {
            const houseSeatCountsDiv = document.getElementById('house-seat-counts');
            const senateSeatCountsDiv = document.getElementById('senate-seat-counts');
            const houseLeadDiv = document.getElementById('house-lead');
            const senateLeadDiv = document.getElementById('senate-lead');

            // Clear existing counts
            houseSeatCountsDiv.innerHTML = '';
            senateSeatCountsDiv.innerHTML = '';
            houseLeadDiv.textContent = '';
            senateLeadDiv.textContent = '';
            houseLeadDiv.className = 'party-lead'; // Reset class
            senateLeadDiv.className = 'party-lead'; // Reset class

            // House Counts
            const houseParties = Object.keys(displayedHouseSeats);
            let uaHouse = displayedHouseSeats['unitedAmerica'] || 0;
            let mfaHouse = displayedHouseSeats['meowForAll'] || 0;
            let otherHouse = 0;
            let housePartySeats = [];

            houseParties.forEach(party => {
                const count = displayedHouseSeats[party] || 0;
                if (party !== 'unitedAmerica' && party !== 'meowForAll') {
                    otherHouse += count;
                }
                 if (partyColors[party]) { // Only add parties with defined colors
                      let partyDisplayName = party.replace(/([A-Z])/g, ' $1').trim();
                      partyDisplayName = partyDisplayName.charAt(0).toUpperCase() + partyDisplayName.slice(1);
                      housePartySeats.push({ name: partyDisplayName, count: count, color: partyColors[party] });
                 }
            });
             // Add Undecided
             const displayedHouseTotal = Object.values(displayedHouseSeats).reduce((sum, count) => sum + count, 0);
             const remainingHouse = totalHouseSeats - displayedHouseTotal;
             if (remainingHouse > 0) {
                  housePartySeats.push({ name: 'Undecided', count: remainingHouse, color: '#ccc' });
             }


            // Sort parties for consistent display order (e.g., UA, MFA, then others alphabetically)
             housePartySeats.sort((a, b) => {
                 if (a.name === 'United America Party') return -1;
                 if (b.name === 'United America Party') return 1;
                 if (a.name === 'Meow For All Party') return -1;
                 if (b.name === 'Meow For All Party') return 1;
                 return a.name.localeCompare(b.name);
             });


            housePartySeats.forEach(item => {
                const countItem = document.createElement('div');
                countItem.className = 'seat-count-item';
                countItem.innerHTML = `<span style="color: ${item.color}; font-weight: bold;">${item.name}:</span> <strong>${item.count}</strong>`;
                houseSeatCountsDiv.appendChild(countItem);
            });

             // House Lead
             if (uaHouse > mfaHouse) {
                 houseLeadDiv.textContent = `United America Lead: +${uaHouse - mfaHouse} seats`;
                 houseLeadDiv.classList.add('ua');
             } else if (mfaHouse > uaHouse) {
                 houseLeadDiv.textContent = `Meow For All Lead: +${mfaHouse - uaHouse} seats`;
                 houseLeadDiv.classList.add('mfa');
             } else if (uaHouse + mfaHouse > 0) { // Only show tie if some seats are reported
                  houseLeadDiv.textContent = 'Tie';
             }


            // Senate Counts
            const senateParties = Object.keys(displayedSenateSeats);
            let uaSenate = displayedSenateSeats['unitedAmerica'] || 0;
            let mfaSenate = displayedSenateSeats['meowForAll'] || 0;
             let otherSenate = 0;
             let senatePartySeats = [];

            senateParties.forEach(party => {
                const count = displayedSenateSeats[party] || 0;
                if (party !== 'unitedAmerica' && party !== 'meowForAll') {
                    otherSenate += count;
                }
                 if (partyColors[party]) {
                      let partyDisplayName = party.replace(/([A-Z])/g, ' $1').trim();
                      partyDisplayName = partyDisplayName.charAt(0).toUpperCase() + partyDisplayName.slice(1);
                      senatePartySeats.push({ name: partyDisplayName, count: count, color: partyColors[party] });
                 }
            });
            // Add Undecided
             const displayedSenateTotal = Object.values(displayedSenateSeats).reduce((sum, count) => sum + count, 0);
             const remainingSenate = totalSenateSeats - displayedSenateTotal;
             if (remainingSenate > 0) {
                  senatePartySeats.push({ name: 'Undecided', count: remainingSenate, color: '#ccc' });
             }

             // Sort parties for consistent display order
             senatePartySeats.sort((a, b) => {
                 if (a.name === 'United America Party') return -1;
                 if (b.name === 'United America Party') return 1;
                 if (a.name === 'Meow For All Party') return -1;
                 if (b.name === 'Meow For All Party') return 1;
                 return a.name.localeCompare(b.name);
             });


            senatePartySeats.forEach(item => {
                const countItem = document.createElement('div');
                countItem.className = 'seat-count-item';
                 countItem.innerHTML = `<span style="color: ${item.color}; font-weight: bold;">${item.name}:</span> <strong>${item.count}</strong>`;
                senateSeatCountsDiv.appendChild(countItem);
            });

             // Senate Lead
             if (uaSenate > mfaSenate) {
                 senateLeadDiv.textContent = `United America Lead: +${uaSenate - mfaSenate} seats`;
                 senateLeadDiv.classList.add('ua');
             } else if (mfaSenate > uaSenate) {
                 senateLeadDiv.textContent = `Meow For All Lead: +${mfaSenate - uaSenate} seats`;
                 senateLeadDiv.classList.add('mfa');
             } else if (uaSenate + mfaSenate > 0) { // Only show tie if some seats are reported
                  senateLeadDiv.textContent = 'Tie';
             }

        }


        // Check for a winner (Presidential only)
        function checkWinner() {
            // Only check if a winner hasn't already been declared AND presidential results are 100%
            if (winnerDeclared || presidentialProgress < 100) {
                return;
            }

            const modal = document.getElementById('winner-modal');
            const winnerName = document.getElementById('winner-name');
            const winnerMessage = document.getElementById('winner-message');
            const exitCode = document.getElementById('exit-code');

            let winner = null;
            let winnerColor = '#ccc';
            let exitCodeValue = '';

            // Determine winner based on FINAL (target) results for the official announcement
             if (targetPresidentialEVs.unitedAmerica >= presidentialThreshold && targetPresidentialEVs.unitedAmerica > targetPresidentialEVs.meowForAll) {
                winner = "John Davis";
                winnerColor = partyColors.unitedAmerica;
                exitCodeValue = "DAVIS" + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            } else if (targetPresidentialEVs.meowForAll >= presidentialThreshold && targetPresidentialEVs.meowForAll > targetPresidentialEVs.unitedAmerica) {
                winner = "Meowbah";
                winnerColor = partyColors.meowForAll;
                exitCodeValue = "MEOW" + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            } else if (targetPresidentialEVs.unitedAmerica === targetPresidentialEVs.meowForAll && targetPresidentialEVs.unitedAmerica >= presidentialThreshold) {
                 // Handle a tie scenario at or above threshold (very unlikely with 538 EVs)
                 winner = "Undecided (Tie)";
                 winnerColor = "#888";
                 exitCodeValue = "TIED" + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            } else {
                 // If 100% reported but no one reached 270 (hung election)
                 winner = "No Winner (Hung Election)";
                 winnerColor = "#888";
                 exitCodeValue = "HUNG" + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            }


            if (winner && !winnerDeclared) {
                winnerDeclared = true;

                winnerName.textContent = winner;
                 if (winner === "Undecided (Tie)" || winner === "No Winner (Hung Election)") {
                     winnerMessage.textContent = winner === "Undecided (Tie)" ? "The presidential election is a tie!" : "No candidate reached the 270 electoral vote threshold.";
                 } else {
                     winnerMessage.textContent = `has won the presidential election with ${Math.max(targetPresidentialEVs.unitedAmerica, targetPresidentialEVs.meowForAll)} electoral votes!`; // Display final count
                 }

                exitCode.textContent = `EXIT CODE: ${exitCodeValue}`;

                winnerName.style.color = winnerColor;

                modal.style.display = 'flex';
            }
        }

        // Close winner modal
        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('winner-modal').style.display = 'none';
        });

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                this.classList.add('active');
                const targetTabId = this.dataset.tab;
                const activeTabContent = document.getElementById(targetTabId);
                activeTabContent.classList.add('active');

                 // Regenerate visualizations for the newly active tab based on *current displayed* results
                 if (targetTabId === 'presidential') {
                     generateArchParliament('presidential-parliament', displayedPresidentialEVs, totalEVs);
                 } else if (targetTabId === 'house') {
                     generateArchParliament('house-parliament', displayedHouseSeats, totalHouseSeats);
                     generateMap('house-map', 100, displayedHouseSeats, Object.keys(displayedHouseSeats), 'district');
                 } else if (targetTabId === 'senate') {
                     generateArchParliament('senate-parliament', displayedSenateSeats, totalSenateSeats);
                     generateMap('senate-map', 50, displayedSenateSeats, Object.keys(displayedSenateSeats), 'state');
                 }

                // Regenerate polling data for the newly active tab
                addPollingData();
            });
        });


        // Reset election button event
        function resetElection() {
            // Stop any ongoing interval
            clearInterval(updateInterval);
            updateInterval = null;

            // Reset displayed seats/EVs to zero
            Object.keys(displayedPresidentialEVs).forEach(p => displayedPresidentialEVs[p] = 0);
            Object.keys(displayedHouseSeats).forEach(p => displayedHouseSeats[p] = 0);
            Object.keys(displayedSenateSeats).forEach(p => displayedSenateSeats[p] = 0);

            // Reset progress percentages
            presidentialProgress = 0;
            houseProgress = 0;
            senateProgress = 0;
            totalProgressAverage = 0;

             winnerDeclared = false; // Reset winner flag

            // Generate *new* random target results for the end of this election cycle
            generateTargetResults();

            // Update the display to show the initial (zero) state
            document.getElementById('davis-votes').textContent = '0';
            document.getElementById('meowbah-votes').textContent = '0';
            document.getElementById('davis-electoral').textContent = '0 electoral votes';
            document.getElementById('meowbah-electoral').textContent = '0 electoral votes';

            const davisProgressBar = document.getElementById('davis-progress');
            const meowbahProgressBar = document.getElementById('meowbah-progress');
            const reportedSpan = document.querySelector('.results-bar span');

            davisProgressBar.style.width = '0%';
            meowbahProgressBar.style.width = '0%';
            davisProgressBar.textContent = '';
            meowbahProgressBar.textContent = '';
             if(reportedSpan) reportedSpan.textContent = '0% Reported';

             // Clear lead and seat counts
             document.getElementById('house-lead').textContent = '';
             document.getElementById('senate-lead').textContent = '';
             document.getElementById('house-seat-counts').innerHTML = '';
             document.getElementById('senate-seat-counts').innerHTML = '';
             document.getElementById('house-speaker').textContent = 'Undetermined';
             document.getElementById('senate-leader').textContent = 'Undetermined';


             // Regenerate visualizations for the initial state (using 0 displayed seats) for the active tab
             const activeTabId = document.querySelector('.tab.active').dataset.tab;
             if (activeTabId === 'presidential') {
                generateArchParliament('presidential-parliament', displayedPresidentialEVs, totalEVs);
             } else if (activeTabId === 'house') {
                generateArchParliament('house-parliament', displayedHouseSeats, totalHouseSeats);
                generateMap('house-map', 100, displayedHouseSeats, Object.keys(targetHouseSeats), 'district'); // Use targetHouseSeats keys for all parties
             } else if (activeTabId === 'senate') {
                generateArchParliament('senate-parliament', displayedSenateSeats, totalSenateSeats);
                generateMap('senate-map', 50, displayedSenateSeats, Object.keys(targetSenateSeats), 'state'); // Use targetSenateSeats keys for all parties
             }


            // Hide winner modal if visible
            document.getElementById('winner-modal').style.display = 'none';

            // Update polling data
             addPollingData();

             // Update metadata
             initializeAdditionalFeatures();

             // Start the gradual update interval only if in Live Mode
             if (isLiveMode) {
                 startUpdateInterval();
             } else {
                 // If in Day mode, update URL to day 0
                 const newUrl = `${window.location.origin}${window.location.pathname}?day=0`;
                 history.replaceState({ day: 0 }, '', newUrl);
             }

            console.log("Election reset.");
        }

        document.getElementById('reset-btn').addEventListener('click', resetElection);


        // Function to start the update interval
        function startUpdateInterval() {
             // Clear any existing interval first
            clearInterval(updateInterval);
            updateInterval = setInterval(stepUpdateResults, updateIntervalTime);
             console.log("Update interval started.");
        }

        // Function to stop the update interval
        function stopUpdateInterval() {
            clearInterval(updateInterval);
            updateInterval = null;
            console.log("Update interval stopped.");
        }

        // Get day parameter from URL
        function getDayFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const day = params.get('day');
            const dayInt = parseInt(day, 10);
            if (!isNaN(dayInt) && dayInt >= 0 && dayInt <= 100) {
                return dayInt;
            }
            return null; // Return null if parameter is missing or invalid
        }

        // Set election state based on a specific 'day' progress (0-100)
        function setElectionStateFromDay(day) {
            const dayProgress = Math.max(0, Math.min(100, day));

            presidentialProgress = dayProgress;
            houseProgress = dayProgress;
            senateProgress = dayProgress;

            // Recalculate displayed seats based on this progress using target results
            const currentTotalDisplayedEVs = Math.floor(totalEVs * (presidentialProgress / 100));
            const currentTotalDisplayedHouse = Math.floor(totalHouseSeats * (houseProgress / 100));
            const currentTotalDisplayedSenate = Math.floor(totalSenateSeats * (senateProgress / 100));

            // Presidential
            displayedPresidentialEVs = { unitedAmerica: 0, meowForAll: 0 };
            if (currentTotalDisplayedEVs > 0) {
                const totalTargetEVs = Object.values(targetPresidentialEVs).reduce((sum, count) => sum + count, 0);
                 if (totalTargetEVs > 0) {
                     displayedPresidentialEVs.unitedAmerica = Math.round((targetPresidentialEVs.unitedAmerica / totalTargetEVs) * currentTotalDisplayedEVs);
                     displayedPresidentialEVs.meowForAll = currentTotalDisplayedEVs - displayedPresidentialEVs.unitedAmerica;
                 } else {
                     // If target is 0, distribute evenly among candidates (shouldn't happen with totalEVs > 0)
                      displayedPresidentialEVs.unitedAmerica = Math.round(currentTotalDisplayedEVs / 2);
                      displayedPresidentialEVs.meowForAll = currentTotalDisplayedEVs - displayedPresidentialEVs.unitedAmerica;
                 }
            }

            // House
            const partiesHouse = Object.keys(targetHouseSeats);
            displayedHouseSeats = {};
            let sumRoundedHouse = 0;
             const totalTargetHouse = Object.values(targetHouseSeats).reduce((sum, count) => sum + count, 0);
            if (currentTotalDisplayedHouse > 0 && totalTargetHouse > 0) {
                partiesHouse.forEach(party => {
                     const targetProportion = targetHouseSeats[party] / totalTargetHouse;
                     displayedHouseSeats[party] = Math.round(targetProportion * currentTotalDisplayedHouse);
                     sumRoundedHouse += displayedHouseSeats[party];
                 });
                let houseDiff = currentTotalDisplayedHouse - sumRoundedHouse;
                 const allParties = Object.keys(targetHouseSeats);
                 while (houseDiff !== 0) {
                     const partyToAdjust = allParties[Math.floor(Math.random() * allParties.length)];
                      if (houseDiff > 0) { displayedHouseSeats[partyToAdjust] = (displayedHouseSeats[partyToAdjust] || 0) + 1; houseDiff--; }
                      else { if((displayedHouseSeats[partyToAdjust] || 0) > 0) { displayedHouseSeats[partyToAdjust]--; houseDiff++; } else { break; } }
                 }
            } else {
                 partiesHouse.forEach(party => displayedHouseSeats[party] = 0);
            }


            // Senate
            const partiesSenate = Object.keys(targetSenateSeats);
            displayedSenateSeats = {};
            let sumRoundedSenate = 0;
            const totalTargetSenate = Object.values(targetSenateSeats).reduce((sum, count) => sum + count, 0);
            if (currentTotalDisplayedSenate > 0 && totalTargetSenate > 0) {
                 partiesSenate.forEach(party => {
                     const targetProportion = targetSenateSeats[party] / totalTargetSenate;
                     displayedSenateSeats[party] = Math.round(targetProportion * currentTotalDisplayedSenate);
                     sumRoundedSenate += displayedSenateSeats[party];
                 });
                let senateDiff = currentTotalDisplayedSenate - sumRoundedSenate;
                 const allParties = Object.keys(targetSenateSeats);
                 while (senateDiff !== 0) {
                      const partyToAdjust = allParties[Math.floor(Math.random() * allParties.length)];
                       if (senateDiff > 0) { displayedSenateSeats[partyToAdjust] = (displayedSenateSeats[partyToAdjust] || 0) + 1; senateDiff--; }
                       else { if((displayedSenateSeats[partyToAdjust] || 0) > 0) { displayedSenateSeats[partyToAdjust]--; senateDiff++; } else { break; } }
                 }
            } else {
                 partiesSenate.forEach(party => displayedSenateSeats[party] = 0);
            }


            // Update UI based on this state
            stepUpdateResults(); // Re-use the update logic

            // If at 100%, declare winner if not already done
            if (presidentialProgress === 100) {
                checkWinner();
            }
             console.log(`Set election state to day ${day}`);
        }


        // Handle Mode Toggle
        const liveModeToggle = document.getElementById('live-mode-toggle');
        const modeLabel = document.getElementById('mode-label');

        function handleModeToggle() {
            isLiveMode = liveModeToggle.checked;
            if (isLiveMode) {
                modeLabel.textContent = 'Live Mode';
                // Remove ?day parameter
                const newUrl = `${window.location.origin}${window.location.pathname}`;
                history.pushState({ day: null }, '', newUrl); // Use pushState for toggle for clearer history
                // Start interval to continue updates from current progress
                startUpdateInterval();
            } else {
                modeLabel.textContent = 'Advance by Day Mode';
                // Add current progress as ?day parameter
                const currentDay = Math.floor(totalProgressAverage);
                const newUrl = `${window.location.origin}${window.location.pathname}?day=${currentDay}`;
                 // Use replaceState here on toggle to keep the history clean after switching
                history.replaceState({ day: currentDay }, '', newUrl);
                // Stop interval
                stopUpdateInterval();
            }
             console.log(`Switched to ${isLiveMode ? 'Live' : 'Advance by Day'} Mode`);
        }

        liveModeToggle.addEventListener('change', handleModeToggle);

        // Handle back/forward button with history state
        window.addEventListener('popstate', function(event) {
             // Check if the state contains our day information
            if (event.state && typeof event.state.day !== 'undefined') {
                 const day = event.state.day;
                 // Update the toggle state without triggering its change listener
                 liveModeToggle.checked = day === null;
                 isLiveMode = liveModeToggle.checked;
                 modeLabel.textContent = isLiveMode ? 'Live Mode' : 'Advance by Day Mode';

                 if (day === null) {
                      // Switched back to Live Mode state, ensure interval is running
                      startUpdateInterval();
                 } else {
                      // Switched to a Day state, stop interval and set state
                      stopUpdateInterval();
                      setElectionStateFromDay(day);
                 }
            } else {
                 // If navigating back to a state without day info, default to Live mode day 0 or initial state
                 console.log("Navigated to state without day info, defaulting to Live Mode.");
                 liveModeToggle.checked = true;
                 handleModeToggle(); // This will set Live Mode and start from current progress
            }
        });


        // Function to handle seat interactivity (hover for info box)
        function addSeatInteractivity(seatElement) {
             const infoBox = document.getElementById('info-box');
             if (!infoBox) return;

             let mouseMoveListener = null;

             const currentMouseMoveListener = function(event) {
                 infoBox.style.left = (event.clientX + 15) + 'px';
                 infoBox.style.top = (event.clientY + 15) + 'px';

                 const rect = infoBox.getBoundingClientRect();
                 if (rect.right > window.innerWidth) { infoBox.style.left = (event.clientX - rect.width - 15) + 'px'; }
                 if (rect.bottom > window.innerHeight) { infoBox.style.top = (event.clientY - rect.height - 15) + 'px'; }
                 if (rect.left < 0) infoBox.style.left = '5px';
                 if (rect.top < 0) infoBox.style.top = '5px';
             };

             seatElement.addEventListener('mouseover', function(e) {
                 const party = this.getAttribute('data-party');
                 const seatIndex = this.getAttribute('data-seat-index');
                 let partyDisplayName = 'Undecided/Remaining';
                 if (party !== 'empty' && partyColors[party]) {
                      partyDisplayName = party.replace(/([A-Z])/g, ' $1').trim();
                      partyDisplayName = partyDisplayName.charAt(0).toUpperCase() + partyDisplayName.slice(1);
                 }
                 const randomName = generateRandomName();

                 infoBox.innerHTML = `
                     <strong>Seat #${seatIndex}</strong><br>
                     Party: ${partyDisplayName}<br>
                     Occupant: ${randomName}
                 `;
                 infoBox.style.display = 'block';

                 mouseMoveListener = currentMouseMoveListener;
                 document.addEventListener('mousemove', mouseMoveListener);
             });

             seatElement.addEventListener('mouseout', function() {
                 infoBox.style.display = 'none';
                 if (mouseMoveListener) {
                     document.removeEventListener('mousemove', mouseMoveListener);
                     mouseMoveListener = null;
                 }
             });
        }

         // Function to handle map interactivity (hover for info box)
        function addMapInteractivity(svgElement, type) {
            const infoBox = document.getElementById('info-box'); // Use the same info box
            if (!infoBox) return;

            const elements = svgElement.querySelectorAll('rect');

            elements.forEach(element => {
                 let mouseMoveListener = null;

                const currentMouseMoveListener = function(event) {
                    infoBox.style.left = (event.clientX + 15) + 'px';
                    infoBox.style.top = (event.clientY + 15) + 'px';

                    const rect = infoBox.getBoundingClientRect();
                    if (rect.right > window.innerWidth) { infoBox.style.left = (event.clientX - rect.width - 15) + 'px'; }
                    if (rect.bottom > window.innerHeight) { infoBox.style.top = (event.clientY - rect.height - 15) + 'px'; }
                    if (rect.left < 0) infoBox.style.left = '5px';
                    if (rect.top < 0) infoBox.style.top = '5px';
                };


                element.addEventListener('mouseover', function(e) {
                    let content = '';
                    const party = this.getAttribute('data-party');
                    let partyDisplayName = 'Undecided/Remaining';
                    if (party !== 'empty' && partyColors[party]) {
                         partyDisplayName = party.replace(/([A-Z])/g, ' $1').trim();
                         partyDisplayName = partyDisplayName.charAt(0).toUpperCase() + partyDisplayName.slice(1);
                    }

                    if (type === 'district') {
                        const districtNumber = this.getAttribute('data-district-id');
                         // Random vote/margin data for flavour
                        const votes = Math.floor(Math.random() * 500000).toLocaleString();
                        const margin = (Math.random() * 20).toFixed(1);

                        content = `
                            <strong>District ${districtNumber}</strong><br>
                            Party: ${partyDisplayName}<br>
                            Votes: ${votes}<br>
                            Margin: ${margin}% lead
                        `;
                    } else if (type === 'state') {
                        const stateAbbr = this.getAttribute('data-state-abbr');
                         // Random vote/margin data for flavour
                        const votes = Math.floor(Math.random() * 2000000).toLocaleString();
                        const margin = (Math.random() * 15).toFixed(1);

                        content = `
                            <strong>State: ${stateAbbr}</strong><br>
                            Party: ${partyDisplayName}<br>
                            Votes: ${votes}<br>
                            Margin: ${margin}% lead<br>
                            Senators: ${Math.floor(Math.random() * 2) + 1}/2
                        `;
                    }

                    infoBox.innerHTML = content;
                    infoBox.style.display = 'block';

                     mouseMoveListener = currentMouseMoveListener;
                     document.addEventListener('mousemove', mouseMoveListener);
                });

                element.addEventListener('mouseout', function() {
                    infoBox.style.display = 'none';
                    if (mouseMoveListener) {
                         document.removeEventListener('mousemove', mouseMoveListener);
                         mouseMoveListener = null;
                    }
                });
            });
        }

        // Function to add or update polling data section
        function addPollingData() {
            const activeTabContent = document.querySelector('.tab-content.active');
            if (!activeTabContent) return;

            let pollingDataSection = activeTabContent.querySelector('.polling-data');
            if (pollingDataSection) {
                 pollingDataSection.remove();
            }

            pollingDataSection = document.createElement('div');
            pollingDataSection.className = 'polling-data';

            const title = document.createElement('h3');
            title.textContent = 'Latest Polling Data';
            pollingDataSection.appendChild(title);

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Party', 'Current', 'Last Week', 'Change'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');

            let partiesToShowKeys = [];
            let totalItemsForShare = 1;
            let targetSeatsData = {};

            if (activeTabContent.id === 'presidential') {
                 partiesToShowKeys = ['unitedAmerica', 'meowForAll'];
                 totalItemsForShare = totalEVs;
                 targetSeatsData = targetPresidentialEVs;
            } else if (activeTabContent.id === 'house') {
                 partiesToShowKeys = Object.keys(partyColors).filter(p => p !== 'empty');
                 totalItemsForShare = totalHouseSeats;
                 targetSeatsData = targetHouseSeats;
            } else if (activeTabContent.id === 'senate') {
                 partiesToShowKeys = Object.keys(partyColors).filter(p => p !== 'empty');
                 totalItemsForShare = totalSenateSeats;
                 targetSeatsData = targetSenateSeats;
            } else {
                 return;
            }

            partiesToShowKeys.forEach(partyKey => {
                const tr = document.createElement('tr');
                 const partyDisplayName = partyKey.replace(/([A-Z])/g, ' $1').trim().charAt(0).toUpperCase() + partyKey.replace(/([A-Z])/g, ' $1').trim().slice(1);

                const partyCell = document.createElement('td');
                partyCell.textContent = partyDisplayName;
                tr.appendChild(partyCell);

                 let targetShare = (targetSeatsData[partyKey] / totalItemsForShare) || 0;
                 let baseCurrent = Math.min(60, targetShare * 100);

                const current = Math.max(1, Math.min(60, Math.floor(baseCurrent + (Math.random() - 0.5) * 12)));

                const currentCell = document.createElement('td');
                currentCell.textContent = `${current}%`;
                tr.appendChild(currentCell);

                const lastWeek = Math.max(1, Math.min(60, Math.floor(current + (Math.random() - 0.5) * 8)));
                const lastWeekCell = document.createElement('td');
                lastWeekCell.textContent = `${lastWeek}%`;
                tr.appendChild(lastWeekCell);

                const change = current - lastWeek;
                const changeCell = document.createElement('td');
                changeCell.textContent = `${change > 0 ? '+' : ''}${change}%`;
                changeCell.style.color = change > 0 ? 'green' : (change < 0 ? 'red' : 'black');
                changeCell.style.fontWeight = 'bold';
                tr.appendChild(changeCell);

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            pollingDataSection.appendChild(table);

            const source = document.createElement('p');
            source.style.fontSize = '0.8em';
            source.style.color = '#666';
            source.style.marginTop = '10px';
            source.textContent = `Source: NM National Opinion Poll (Margin of Error: ${(Math.random() * 2 + 1.5).toFixed(1)}%)`;
            pollingDataSection.appendChild(source);

            activeTabContent.appendChild(pollingDataSection);
        }


        // Function to initialize additional features (metadata, viewer counter)
        function initializeAdditionalFeatures() {
            // Add live viewership counter
            const header = document.querySelector('header');
            let viewerCounter = header.querySelector('.viewer-counter');
             if (!viewerCounter) {
                 viewerCounter = document.createElement('div');
                 viewerCounter.className = 'viewer-counter';
                 header.appendChild(viewerCounter);

                 const initialViewers = Math.floor(Math.random() * 500000) + 1000000;
                 viewerCounter.textContent = `Live Viewers: ${initialViewers.toLocaleString()}`;

                 setInterval(() => {
                     const currentViewersText = viewerCounter.textContent.replace('Live Viewers: ', '').replace(/,/g, '');
                     let currentViewers = parseInt(currentViewersText, 10);
                      if (isNaN(currentViewers)) currentViewers = 1000000;

                     const change = Math.floor(Math.random() * 20000) - 10000;
                     const newViewers = Math.max(500000, currentViewers + change);
                     viewerCounter.textContent = `Live Viewers: ${newViewers.toLocaleString()}`;
                 }, 5000);
             }


            // Add/Update metadata about the election
            const electionInfo = document.querySelector('.election-info');
            let metadataSection = electionInfo.querySelector('.election-metadata');
            if (!metadataSection) {
                 metadataSection = document.createElement('div');
                 metadataSection.className = 'election-metadata';
                 electionInfo.appendChild(metadataSection);
             } else {
                 metadataSection.innerHTML = '';
             }

             const metadataItems = [
                { label: 'Polls Reporting', value: `${Math.floor(totalProgressAverage).toString()}%` },
                 // Scale random votes by reported percentage, plus a base amount
                 { label: 'Total Votes Counted', value: `${Math.floor((Math.random() * 70000000 + 30000000) * (totalProgressAverage / 100) + (totalProgressAverage > 0 ? 500000 : 0)).toLocaleString()}` },
                { label: 'Projected Turnout', value: `${(Math.random() * 10 + 65).toFixed(1)}%` },
                { label: 'Electoral Votes Needed to Win', value: presidentialThreshold.toString() }
            ];

            metadataItems.forEach(item => {
                const metadataItem = document.createElement('div');

                const label = document.createElement('div');
                label.className = 'label';
                label.textContent = item.label;

                const value = document.createElement('div');
                value.className = 'value';
                value.textContent = item.value;

                metadataItem.appendChild(label);
                metadataItem.appendChild(value);
                metadataSection.appendChild(metadataItem);
            });
        }


        // Initialize on page load
        window.addEventListener('load', function() {
             // Check for URL parameter on load
            const initialDay = getDayFromUrl();

            // Generate target results first, needed for setting state
            generateTargetResults();

            if (initialDay !== null) {
                 // Start in Advance by Day mode, set progress from URL
                 liveModeToggle.checked = false;
                 isLiveMode = false;
                 modeLabel.textContent = 'Advance by Day Mode';
                 // Set state based on the day parameter
                 setElectionStateFromDay(initialDay);
                 // No interval starts automatically in day mode
            } else {
                 // Start in Live Mode (default), begin gradual update from 0
                 liveModeToggle.checked = true; // Ensure checkbox is checked
                 isLiveMode = true;
                 modeLabel.textContent = 'Live Mode';
                 resetElection(); // This generates targets and starts the interval
            }


            // Initialize other features
            initializeAdditionalFeatures(); // Adds viewer counter and initial metadata
            updateCommentary(); // Adds initial commentary

        });

        // Handle window resize to redraw arch parliaments and maps
        window.addEventListener('resize', function() {
             // Redraw visualizations for the active tab based on current displayed state
            const activeTabId = document.querySelector('.tab.active').dataset.tab;
            if (!activeTabId) return;

            if (activeTabId === 'presidential') {
                 generateArchParliament('presidential-parliament', displayedPresidentialEVs, totalEVs);
            } else if (activeTabId === 'house') {
                 generateArchParliament('house-parliament', displayedHouseSeats, totalHouseSeats);
                 generateMap('house-map', 100, displayedHouseSeats, Object.keys(targetHouseSeats), 'district');
            } else if (activeTabId === 'senate') {
                 generateArchParliament('senate-parliament', displayedSenateSeats, totalSenateSeats);
                 generateMap('senate-map', 50, displayedSenateSeats, Object.keys(targetSenateSeats), 'state');
            }
             // Update metadata on resize to refresh display based on current progress
             initializeAdditionalFeatures();
        });

        // Update commentary periodically
        setInterval(updateCommentary, 15000); // Add a new commentary every 15 seconds

    </script>
</body>
</html>